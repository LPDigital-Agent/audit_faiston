(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,8419,78479,56374,32017,46571,7487,49123,22994,544,55909,7112,19249,83509,96524,11426,e=>{"use strict";var t=e.i(18939),r=e.i(33207),a=e.i(63257),n=e.i(64583);e.i(8923);var s=e.i(12507);let o="sga-assets";function i({initialPageSize:e=20,autoFetch:l=!0}={}){let u=(0,a.useQueryClient)(),{assetFilters:c,setAssetFilters:d,resetAssetFilters:m}=(0,s.useAssetManagement)(),[p,g]=(0,t.useState)(1),[y,_]=(0,t.useState)(e),[f,v]=(0,t.useState)({field:"updated_at",direction:"desc"}),{data:h,isLoading:w,isError:b,error:S,refetch:E}=(0,r.useQuery)({queryKey:[o,c,p,y,f],queryFn:async()=>(await (0,n.searchAssets)({query:c.search||void 0,part_number:c.part_number,location_id:c.location_id,project_id:c.project_id,status:c.status,page:p,page_size:y})).data,enabled:l,staleTime:3e4}),k=h?.assets??[],C=h?.total??0,q=Math.ceil(C/y),A=p<q,x=p>1,M=(0,t.useCallback)(e=>{e>=1&&e<=q&&g(e)},[q]),F=(0,t.useCallback)(()=>{A&&g(e=>e+1)},[A]),R=(0,t.useCallback)(()=>{x&&g(e=>e-1)},[x]),P=(0,t.useCallback)(e=>{_(e),g(1)},[]),I=(0,t.useCallback)((e,t)=>{d({[e]:t}),g(1)},[d]),N=(0,t.useCallback)(()=>{m(),g(1)},[m]),T=(0,t.useCallback)(e=>{v(t=>({field:e,direction:t.field===e&&"asc"===t.direction?"desc":"asc"}))},[]);return{assets:k,total:C,isLoading:w,isError:b,error:S,page:p,pageSize:y,totalPages:q,hasNextPage:A,hasPreviousPage:x,goToPage:M,nextPage:F,previousPage:R,setPageSize:P,filters:c,setFilter:I,clearFilters:N,sortConfig:f,setSortConfig:v,toggleSort:T,refetch:(0,t.useCallback)(()=>{u.invalidateQueries({queryKey:[o]}),E()},[u,E])}}function l({serialNumber:e,enabled:t=!0}){let{data:a,isLoading:s,isError:o,error:i,refetch:l}=(0,r.useQuery)({queryKey:["sga-asset-detail",e],queryFn:async()=>(await (0,n.whereIsSerial)({serial_number:e})).data,enabled:t&&!!e,staleTime:6e4});return{asset:a?.asset??null,timeline:a?.timeline??[],found:a?.found??!1,isLoading:s,isError:o,error:i,refetch:l}}function u({initialPageSize:e=20,autoFetch:a=!0}={}){let{movementFilters:o,setMovementFilters:i,resetMovementFilters:l}=(0,s.useAssetManagement)(),[c,d]=(0,t.useState)(1),[m,p]=(0,t.useState)(e),[g,y]=(0,t.useState)({field:"created_at",direction:"desc"}),{data:_,isLoading:f,isError:v,error:h,refetch:w}=(0,r.useQuery)({queryKey:["sga-movements",o,c,m,g],queryFn:async()=>(await (0,n.invokeSGAAgentCore)({action:"get_movements",query:o.search||void 0,type:o.type,part_number:o.part_number,location_id:o.location_id,project_id:o.project_id,date_from:o.date_from,date_to:o.date_to,page:c,page_size:m,sort_field:g.field,sort_direction:g.direction})).data,enabled:a,staleTime:3e4}),b=_?.movements??[],S=_?.total??0,E=Math.ceil(S/m),k=c<E,C=c>1,q=(0,t.useCallback)(e=>{e>=1&&e<=E&&d(e)},[E]),A=(0,t.useCallback)(()=>{k&&d(e=>e+1)},[k]),x=(0,t.useCallback)(()=>{C&&d(e=>e-1)},[C]),M=(0,t.useCallback)(e=>{p(e),d(1)},[]),F=(0,t.useCallback)((e,t)=>{i({[e]:t}),d(1)},[i]),R=(0,t.useCallback)(()=>{l(),d(1)},[l]),P=(0,t.useCallback)(e=>{y(t=>({field:e,direction:t.field===e&&"asc"===t.direction?"desc":"asc"}))},[]);return{movements:b,total:S,isLoading:f,isError:v,error:h,page:c,pageSize:m,totalPages:E,hasNextPage:k,hasPreviousPage:C,goToPage:q,nextPage:A,previousPage:x,setPageSize:M,filters:o,setFilter:F,clearFilters:R,sortConfig:g,setSortConfig:y,toggleSort:P,refetch:w}}e.s(["useAssets",()=>i],78479),e.s(["useAssetDetail",()=>l],56374),e.s(["useMovements",()=>u],32017);var c=e.i(30209),d=e.i(8317),m=e.i(62224);function p(){let e=(0,a.useQueryClient)(),{createNewReservation:t,cancelExistingReservation:r,processNewExpedition:n,createNewTransfer:s,processNewReturn:o,operationStatus:i,operationError:l,resetOperation:u}=(0,d.useInventoryOperations)(),p=()=>{e.invalidateQueries({queryKey:["sga-assets"]}),e.invalidateQueries({queryKey:["sga-balance"]}),e.invalidateQueries({queryKey:["sga-movements"]})},g=(0,c.useMutation)({mutationFn:async e=>{let r=await t(e);if(!r.success)throw Error((0,m.safeExtractErrorMessage)(r.error));return r.data},onSuccess:()=>{p()}}),y=(0,c.useMutation)({mutationFn:async({reservationId:e,reason:t})=>{let a=await r(e,t);if(!a.success)throw Error((0,m.safeExtractErrorMessage)(a.error));return a.data},onSuccess:()=>{p()}}),_=(0,c.useMutation)({mutationFn:async e=>{let t=await n(e);if(!t.success)throw Error((0,m.safeExtractErrorMessage)(t.error));return t.data},onSuccess:()=>{p()}}),f=(0,c.useMutation)({mutationFn:async e=>{let t=await s(e);if(!t.success)throw Error((0,m.safeExtractErrorMessage)(t.error));return t.data},onSuccess:()=>{p()}}),v=(0,c.useMutation)({mutationFn:async e=>{let t=await o(e);if(!t.success)throw Error((0,m.safeExtractErrorMessage)(t.error));return t.data},onSuccess:()=>{p()}});return{createReservation:{mutate:g.mutate,mutateAsync:g.mutateAsync,isPending:g.isPending,isError:g.isError,error:g.error,data:g.data},cancelReservation:{mutate:y.mutate,mutateAsync:y.mutateAsync,isPending:y.isPending,isError:y.isError,error:y.error},processExpedition:{mutate:_.mutate,mutateAsync:_.mutateAsync,isPending:_.isPending,isError:_.isError,error:_.error,data:_.data},createTransfer:{mutate:f.mutate,mutateAsync:f.mutateAsync,isPending:f.isPending,isError:f.isError,error:f.error,data:f.data},processReturn:{mutate:v.mutate,mutateAsync:v.mutateAsync,isPending:v.isPending,isError:v.isError,error:v.error,data:v.data},operationStatus:i,operationError:l,resetOperation:u}}function g(){let{validateMovement:e,operationError:r,resetOperation:a}=(0,d.useInventoryOperations)(),[n,s]=(0,t.useState)(!1),[o,i]=(0,t.useState)(null),[l,u]=(0,t.useState)(null),c=(0,t.useCallback)(async t=>{s(!0),i(null);try{let r=await e(t.operationType,t.partNumber,t.quantity,t.sourceLocationId,t.destinationLocationId,t.projectId);return u(r),r}catch(e){throw i(e instanceof Error?e.message:"Erro na validacao"),e}finally{s(!1)}},[e]),m=(0,t.useCallback)(()=>{u(null),i(null),a()},[a]),p=l?.is_valid??!1,g=l?.requires_approval??!1,y=l?.approval_role??null,_=l?.violations.map(e=>e.description)??[],f=l?.warnings??[];return{validation:l,isValidating:n,validationError:o||r,isValid:p,requiresApproval:g,approvalRole:y,violations:_,warnings:f,validate:c,clearValidation:m}}function y(){let{locations:e,masterDataLoading:r,masterDataError:a,refreshMasterData:o,getLocationById:i}=(0,s.useAssetManagement)(),l=(0,t.useMemo)(()=>e.filter(e=>e.is_active),[e]),u=(0,t.useMemo)(()=>e.filter(e=>"WAREHOUSE"===e.type&&e.is_active),[e]),d=(0,t.useMemo)(()=>e.filter(e=>"CUSTOMER"===e.type&&e.is_active),[e]),m=(0,t.useMemo)(()=>e.filter(e=>e.is_restricted&&e.is_active),[e]),p=(0,t.useCallback)(t=>e.find(e=>e.code===t),[e]),g=(0,c.useMutation)({mutationFn:async e=>(await (0,n.createLocation)(e)).data.location,onSuccess:()=>{o()}});return{locations:e,isLoading:r,error:a,activeLocations:l,warehouseLocations:u,customerLocations:d,restrictedLocations:m,getLocationById:i,getLocationByCode:p,createNewLocation:{mutate:g.mutate,mutateAsync:g.mutateAsync,isPending:g.isPending,isError:g.isError,error:g.error},refresh:o}}function _(){let{partNumbers:e,masterDataLoading:r,masterDataError:a,refreshMasterData:o,getPartNumberById:i}=(0,s.useAssetManagement)(),[l,u]=(0,t.useState)(""),[d,m]=(0,t.useState)(),[p,g]=(0,t.useState)(!1),y=(0,t.useMemo)(()=>{if(!l)return e;let t=l.toLowerCase();return e.filter(e=>e.part_number.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)||e.category?.toLowerCase().includes(t))},[e,l]),_=(0,t.useMemo)(()=>e.filter(e=>e.is_active),[e]),f=(0,t.useMemo)(()=>e.filter(e=>e.is_serialized&&e.is_active),[e]),v=(0,t.useMemo)(()=>e.reduce((e,t)=>{let r=t.category||"Outros";return e[r]||(e[r]=[]),e[r].push(t),e},{}),[e]),h=(0,t.useCallback)(t=>e.find(e=>e.part_number===t),[e]),w=(0,c.useMutation)({mutationFn:async e=>{let t=await (0,n.createPartNumber)(e);if(t.data.hil_task_id){m(t.data.hil_task_id),g(!0);return}return g(!1),m(void 0),t.data.part_number},onSuccess:e=>{e&&o()}});return{partNumbers:e,isLoading:r,error:a,searchTerm:l,setSearchTerm:u,filteredPartNumbers:y,activePartNumbers:_,serializedPartNumbers:f,categorizedPartNumbers:v,getPartNumberById:i,getPartNumberByCode:h,createNewPartNumber:{mutate:w.mutate,mutateAsync:w.mutateAsync,isPending:w.isPending,isError:w.isError,error:w.error,requiresApproval:p,hilTaskId:d},refresh:o}}function f(){let{projects:e,masterDataLoading:r,masterDataError:a,refreshMasterData:o,getProjectById:i}=(0,s.useAssetManagement)(),[l,u]=(0,t.useState)(""),d=(0,t.useMemo)(()=>{if(!l)return e;let t=l.toLowerCase();return e.filter(e=>e.code.toLowerCase().includes(t)||e.name.toLowerCase().includes(t)||e.client_name.toLowerCase().includes(t))},[e,l]),m=(0,t.useMemo)(()=>e.filter(e=>e.is_active),[e]),p=(0,t.useCallback)(t=>e.find(e=>e.code===t),[e]),g=(0,c.useMutation)({mutationFn:async e=>(await (0,n.createProject)(e)).data.project,onSuccess:()=>{o()}});return{projects:e,isLoading:r,error:a,searchTerm:l,setSearchTerm:u,filteredProjects:d,activeProjects:m,getProjectById:i,getProjectByCode:p,createNewProject:{mutate:g.mutate,mutateAsync:g.mutateAsync,isPending:g.isPending,isError:g.isError,error:g.error},refresh:o}}function v(){let e=(0,a.useQueryClient)(),[r,s]=(0,t.useState)(!1),[o,i]=(0,t.useState)(null),[l,u]=(0,t.useState)(null),[d,p]=(0,t.useState)([]),[g,y]=(0,t.useState)([]),[_,f]=(0,t.useState)([]),[v,h]=(0,t.useState)({}),[w,b]=(0,t.useState)(null),[S,E]=(0,t.useState)(null),[k,C]=(0,t.useState)(),[q,A]=(0,t.useState)(),x=(0,c.useMutation)({mutationFn:async e=>(await (0,n.previewImport)(e)).data,onSuccess:e=>{e.success?(u(e),p(e.column_mappings),y(e.matched_rows),f(e.unmatched_rows),i(null)):i((0,m.safeExtractErrorMessage)(e.error)||"Erro ao processar arquivo")},onError:e=>{i(e instanceof Error?e.message:"Erro ao processar arquivo")}}),M=(0,c.useMutation)({mutationFn:async()=>{if(!l||!S||!w)throw Error("Nenhum arquivo carregado para importar");return(await (0,n.executeImport)({import_id:l.import_id,file_content_base64:S,filename:w,column_mappings:d.map(e=>({file_column:e.file_column,target_field:e.target_field})),pn_overrides:v,project_id:k,destination_location_id:q})).data},onSuccess:t=>{t.success&&(e.invalidateQueries({queryKey:["sga-assets"]}),e.invalidateQueries({queryKey:["sga-balance"]}),e.invalidateQueries({queryKey:["sga-movements"]}))}}),F=(0,t.useCallback)(async(e,t,r)=>{s(!0),i(null);try{let a=await new Promise((t,r)=>{let a=new FileReader;a.onload=()=>{let e=a.result,r=e.includes(",")?e.split(",")[1]:e;t(r)},a.onerror=()=>r(Error("Erro ao ler arquivo")),a.readAsDataURL(e)});return b(e.name),E(a),C(t),A(r),await x.mutateAsync({file_content_base64:a,filename:e.name,project_id:t,destination_location_id:r})}catch(e){return i(e instanceof Error?e.message:"Erro ao processar arquivo"),null}finally{s(!1)}},[x]),R=(0,t.useCallback)(async()=>{s(!0),i(null);try{let e=await M.mutateAsync();return e.success||i((0,m.safeExtractErrorMessage)(e.error)||"Erro na importação"),e}catch(e){return i(e instanceof Error?e.message:"Erro na importação"),null}finally{s(!1)}},[M]),P=(0,t.useCallback)((e,t)=>{p(r=>r.map((r,a)=>a===e?{...r,target_field:t}:r))},[]),I=(0,t.useCallback)((e,t)=>{h(r=>({...r,[e]:t}))},[]),N=(0,t.useCallback)(e=>{h(t=>{let r={...t};return delete r[e],r})},[]),T=(0,t.useCallback)(async(e,t)=>{try{return(await (0,n.validatePNMapping)({description:e,suggested_pn_id:t})).data}catch{return null}},[]),O=(0,t.useCallback)(()=>{u(null),p([]),y([]),f([]),h({}),b(null),E(null),C(void 0),A(void 0),i(null)},[]);return{isLoading:r,isPreviewing:x.isPending,isExecuting:M.isPending,error:o,preview:l,columnMappings:d,matchedRows:g,unmatchedRows:_,pnOverrides:v,uploadAndPreview:F,executeImportAction:R,updateColumnMapping:P,setPNOverride:I,removePNOverride:N,validateMapping:T,clearImport:O,filename:w,fileContent:S}}function h(){let e=(0,a.useQueryClient)(),[r,s]=(0,t.useState)(!1),[o,i]=(0,t.useState)(null),[l,u]=(0,t.useState)([p()]),[d,m]=(0,t.useState)(null);function p(){return{id:crypto.randomUUID(),part_number_id:"",part_number_code:"",quantity:1,serial_numbers:"",unit_value:0,notes:""}}let g=(0,t.useCallback)(()=>{u(e=>[...e,p()])},[]),y=(0,t.useCallback)(e=>{u(t=>t.length<=1?t:t.filter(t=>t.id!==e))},[]),_=(0,t.useCallback)((e,t,r)=>{u(a=>a.map(a=>a.id!==e?a:{...a,[t]:r}))},[]),f=(0,t.useCallback)(()=>{u([p()]),i(null)},[]),v=(0,c.useMutation)({mutationFn:async e=>{let t=e.items.filter(e=>e.part_number_id&&e.quantity>0);if(0===t.length)throw Error("Adicione pelo menos um item valido");let r=t.map(e=>({part_number_id:e.part_number_id,quantity:e.quantity,serial_numbers:e.serial_numbers?e.serial_numbers.split(",").map(e=>e.trim()).filter(Boolean):void 0,unit_value:e.unit_value>0?e.unit_value:void 0,notes:e.notes||void 0}));return(await (0,n.createManualEntry)({items:r,project_id:e.project_id,destination_location_id:e.destination_location_id,document_reference:e.document_reference,notes:e.notes})).data},onSuccess:t=>{m(t),u([p()]),e.invalidateQueries({queryKey:["sga-assets"]}),e.invalidateQueries({queryKey:["sga-balance"]}),e.invalidateQueries({queryKey:["sga-movements"]})}}),h=(0,t.useCallback)(async e=>{s(!0),i(null);try{return await v.mutateAsync({...e,items:l})}catch(e){throw i(e instanceof Error?e.message:"Erro ao registrar entrada"),e}finally{s(!1)}},[v,l]),w=(0,t.useCallback)(()=>{m(null),i(null)},[]),b=l.filter(e=>e.part_number_id&&e.quantity>0).length,S=l.reduce((e,t)=>e+(t.quantity||0),0);return{isProcessing:r,error:o,items:l,addItem:g,removeItem:y,updateItem:_,clearItems:f,submitEntry:h,result:d,clearResult:w,totalItems:b,totalQuantity:S,isValid:b>0}}function w(e){let t,r;if(!e||"object"!=typeof e)throw Error("Invalid response: not an object");let a=e.analysis||{sheets:[],sheet_count:0,total_rows:0,recommended_strategy:"manual_review"},n={sheets:Array.isArray(a.sheets)?a.sheets:[],sheet_count:Number(a.sheet_count)||0,total_rows:Number(a.total_rows)||0,recommended_strategy:String(a.recommended_strategy||"manual_review")};return{success:!!e.success,error:e.error,import_session_id:String(e.import_session_id||""),filename:String(e.filename||""),detected_file_type:String(e.detected_file_type||"unknown"),analysis:n,column_mappings:(t=Array.isArray(e.column_mappings)?e.column_mappings:[],Array.isArray(e.column_mappings)&&0!==e.column_mappings.length||console.warn("[BUG-023] column_mappings is empty or missing:",e.column_mappings),t),overall_confidence:(r=Number(e.overall_confidence)||0,(void 0===e.overall_confidence||null===e.overall_confidence)&&console.warn("[BUG-023] overall_confidence is missing from response"),r),mapping_confidence:void 0!==e.mapping_confidence?Number(e.mapping_confidence):void 0,mapping_complete:!0===e.mapping_complete,questions:function(e){if(!Array.isArray(e))return null!=e&&console.error("[NEXO BUG-025] questions is not array:",typeof e,e),[];let t=e.filter((e,t)=>!!(e&&"object"==typeof e&&e.question&&"string"==typeof e.question&&1)||(console.warn("[NEXO BUG-025] Filtering invalid question at index",t,e),!1));return e.length!==t.length&&console.warn("[NEXO BUG-025] Filtered invalid questions:",{raw:e.length,valid:t.length,filtered:e.length-t.length}),t}(e.questions),unmapped_questions:Array.isArray(e.unmapped_questions)&&e.unmapped_questions.length>0?e.unmapped_questions:void 0,reasoning_trace:Array.isArray(e.reasoning_trace)?e.reasoning_trace:[],user_id:e.user_id,session_id:e.session_id,session_state:e.session_state}}function b(e){if(!e||"object"!=typeof e)return!1;let t=e.analysis?.sheets!==void 0,r=e.analysis?.file_analysis!==void 0,a="column_mappings"in e,n="columns"in e&&Array.isArray(e.columns)&&e.columns.length>0;return t||r||a||n}e.s(["useMovementMutations",()=>p],46571),e.s(["useMovementValidation",()=>g],7487),e.s(["useLocations",()=>y],49123),e.s(["usePartNumbers",()=>_],22994),e.s(["useProjects",()=>f],544),e.s(["useBulkImport",()=>v],55909),e.s(["useManualEntry",()=>h],7112),e.s(["hasValidAnalysisData",()=>b,"normalizeNexoResponse",()=>w],19249);var S=e.i(44621);let E={xml:"XML (Nota Fiscal)",pdf:"PDF (Documento)",image:"Imagem (JPG/PNG)",csv:"CSV (Planilha)",xlsx:"Excel (XLSX)",txt:"Texto (TXT)",unknown:"Formato desconhecido"},k={accept:".xml,.pdf,.jpg,.jpeg,.png,.csv,.xlsx,.txt",mimeTypes:["application/xml","text/xml","application/pdf","image/jpeg","image/png","image/gif","image/webp","text/csv","application/csv","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/plain"],maxFileSize:0x3200000};function C(e){return["nf_xml","nf_pdf","nf_image"].includes(e.source_type)}function q(e){return"spreadsheet"===e.source_type}function A(e){return"text"===e.source_type}let x={nf_xml:.9,nf_pdf:.8,nf_image:.7,spreadsheet:.8,text:0,unknown:0};function M(e){if("text"===e.source_type||"requires_hil"in e&&e.requires_hil||"requires_review"in e&&e.requires_review)return!0;if("confidence_score"in e&&e.confidence_score){let t=x[e.source_type];return e.confidence_score.overall<t}if("confidence"in e&&"number"==typeof e.confidence){let t=x[e.source_type];return e.confidence<t}return!1}function F(e){return E[e]||"Formato desconhecido"}function R(e){return({xml:"xml",pdf:"pdf",jpg:"image",jpeg:"image",png:"image",gif:"image",webp:"image",csv:"csv",xlsx:"xlsx",xls:"xlsx",txt:"txt",text:"txt",md:"txt"})[e.name.toLowerCase().split(".").pop()||""]||"unknown"}function P(e){if(e.size>k.maxFileSize){let e=k.maxFileSize/1048576;return`Arquivo muito grande. Tamanho m\xe1ximo: ${e}MB`}if("unknown"===R(e)){let t=e.name.split(".").pop()||"";return`Formato ".${t}" n\xe3o suportado. Use: XML, PDF, CSV, XLSX, JPG, PNG ou TXT`}return null}e.s(["SMART_IMPORT_FORMATS",0,k,"detectFileTypeFromFile",()=>R,"getFileTypeLabel",()=>F,"isNFImportResult",()=>C,"isSpreadsheetImportResult",()=>q,"isTextImportResult",()=>A,"requiresHILReview",()=>M,"validateSmartImportFile",()=>P],83509);let I={stage:"idle",percent:0,message:""},N="sga-pending-nf-entries",T={sessionId:null,sessionState:null,isAnalyzing:!1,sheets:[],columnMappings:[],questions:[],answers:{},reasoningTrace:[],overallConfidence:0,error:null};function O(){let e=(0,a.useQueryClient)(),[s,o]=(0,t.useState)(null),[i,l]=(0,t.useState)(!1),[u,c]=(0,t.useState)(T),{data:d,isLoading:p,refetch:g}=(0,r.useQuery)({queryKey:[N],queryFn:async()=>(await (0,n.getPendingNFEntries)()).data.entries,staleTime:6e4,retry:1}),[y,_]=(0,t.useState)(!1),[f,v]=(0,t.useState)(I),[h,b]=(0,t.useState)(null),[E,k]=(0,t.useState)(null),[x,M]=(0,t.useState)(null),O=(0,t.useCallback)(async(e,t,r)=>{_(!0),b(null),k(null),M(null),v({stage:"detecting",percent:5,message:"Detectando tipo de arquivo..."}),(0,n.clearSGASession)(),console.log("[SmartImporter] Session cleared - forcing cold start");try{let a=P(e);if(a)throw Error(a);let s=R(e);if(o(s),v({stage:"detecting",percent:10,message:`Tipo detectado: ${F(s)}`}),"unknown"===s)throw Error("Formato de arquivo não suportado");v({stage:"uploading",percent:20,message:"Obtendo URL de upload..."});let i=e.type||L(s),l=await (0,n.getNFUploadUrl)({filename:e.name,content_type:i}),u=(0,m.extractAgentResponse)(l.data);if(!u||!u.upload_url||!u.s3_key){let e=u?.error||"Falha ao obter URL de upload",t=(0,m.safeExtractErrorMessage)(e);throw Error(t)}v({stage:"uploading",percent:40,message:"Enviando arquivo..."});let c=u.required_headers||{"Content-Type":i};if(!(await fetch(u.upload_url,{method:"PUT",body:e,headers:c})).ok)throw Error("Falha no upload do arquivo");v({stage:"processing",percent:70,message:"Processando arquivo..."});let d=await (0,n.invokeSmartImport)({s3_key:u.s3_key,filename:e.name,content_type:i,project_id:t||void 0,destination_location_id:r||void 0});v({stage:"complete",percent:100,message:"Processamento concluído!"}),console.log("[SmartImporter] Raw smartResult:",JSON.stringify(d,null,2)),console.log("[SmartImporter] smartResult.data:",d.data),console.log("[SmartImporter] smartResult.data.preview:",d.data?.preview),console.log("[SmartImporter] smartResult.data.source_type:",d.data?.source_type);let p=d.data,g=p?.preview||(p?.source_type?p:null);if(console.log("[SmartImporter] Resolved previewResult:",g),k(g),M(d.data),p?.success===!1&&p?.error){let e=d.debug_analysis,t=(0,m.safeExtractErrorMessage)(p.error);throw console.log("[SmartImporter] AUDIT-002: Application error with debug_analysis:",e),b({message:t,debug_analysis:e}),v({stage:"error",percent:0,message:t}),Error(t)}let y=d.data?.detected_type||g?.detected_file_type;return o(y||null),g}catch(a){let e,t=a instanceof Error?a.message:"Erro ao processar arquivo",r=(0,m.safeExtractErrorMessage)(t);throw a instanceof S.AgentCoreError&&a.debug_analysis&&(e=a.debug_analysis,console.log("[SmartImporter] BUG-027: Extracted debug_analysis from error")),b({message:r,debug_analysis:e}),v({stage:"error",percent:0,message:r}),a}finally{_(!1)}},[]),U=(0,t.useCallback)(()=>{k(null),M(null),o(null),b(null),v(I)},[]),j=(0,t.useCallback)(async()=>{if(!E)throw Error("Nenhum preview disponível para confirmar");if(C(E)){let t=await (0,n.confirmNFEntry)({entry_id:E.entry_id,item_mappings:E.suggested_mappings,notes:void 0});if(!t.data.success)throw Error(t.data.errors?.join(", ")||"Erro ao confirmar entrada");e.invalidateQueries({queryKey:["sga-assets"]}),e.invalidateQueries({queryKey:["sga-balance"]}),e.invalidateQueries({queryKey:["sga-movements"]}),e.invalidateQueries({queryKey:["sga-pending-nf-entries"]}),U();return}if(q(E)){console.warn("Spreadsheet confirmation not yet implemented"),U();return}if(A(E))throw Error("Importações de texto requerem revisão manual antes de confirmar");throw Error("Tipo de preview desconhecido")},[E,e,U]),Q=(0,t.useCallback)(async(t,r)=>{try{await (0,n.assignProjectToEntry)(t,r),e.invalidateQueries({queryKey:[N]})}catch(e){throw Error(e instanceof Error?e.message:"Erro ao atribuir projeto")}},[e]),K=(0,t.useCallback)(async e=>{c(e=>({...e,isAnalyzing:!0,error:null})),_(!0),b(null),v({stage:"detecting",percent:5,message:"NEXO analisando arquivo..."}),(0,n.clearSGASession)();try{let t=P(e);if(t)throw Error(t);let r=R(e);o(r),v({stage:"uploading",percent:20,message:"Obtendo URL de upload..."});let a=e.type||L(r),s=await (0,n.getNFUploadUrl)({filename:e.name,content_type:a}),i=(0,m.extractAgentResponse)(s.data);if(!i?.upload_url||!i?.s3_key)throw Error("Falha ao obter URL de upload");v({stage:"uploading",percent:40,message:"Enviando arquivo..."});let l=i.required_headers||{"Content-Type":a};if(!(await fetch(i.upload_url,{method:"PUT",body:e,headers:l})).ok)throw Error("Falha no upload do arquivo");v({stage:"processing",percent:60,message:"NEXO analisando estrutura..."});let u=await (0,n.nexoAnalyzeFile)({s3_key:i.s3_key,filename:e.name,content_type:a});if(!u.data?.success)throw Error("Falha na análise NEXO");let d=u.data,p=w(d);console.log("[SmartImporter] BUG-022 v14: Normalized response structure");let g=p.session_state||{session_id:p.import_session_id,filename:e.name,s3_key:i.s3_key,stage:p.questions&&p.questions.length>0?"questioning":"processing",file_analysis:{sheets:p.analysis.sheets,sheet_count:p.analysis.sheet_count,total_rows:p.analysis.total_rows,detected_type:p.detected_file_type,recommended_strategy:p.analysis.recommended_strategy},reasoning_trace:p.reasoning_trace||[],questions:p.questions||[],answers:{},learned_mappings:{},ai_instructions:{},requested_new_columns:[],column_mappings:p.column_mappings.reduce((e,t)=>(e[t.file_column]=t.target_field,e),{}),confidence:{overall:p.overall_confidence,extraction_quality:1,evidence_strength:1,historical_match:1,risk_level:p.overall_confidence>=.8?"low":p.overall_confidence>=.5?"medium":"high",factors:[],requires_hil:p.overall_confidence<.6},error:null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},y={sessionId:p.import_session_id,sessionState:g,isAnalyzing:!1,sheets:p.analysis.sheets,columnMappings:p.column_mappings,questions:p.questions||[],answers:{},reasoningTrace:p.reasoning_trace||[],overallConfidence:p.overall_confidence,error:null};return c(y),v({stage:"complete",percent:100,message:"Análise NEXO concluída!"}),y}catch(r){let e,t=r instanceof Error?r.message:"Erro na análise NEXO";throw r instanceof S.AgentCoreError&&r.debug_analysis&&(e=r.debug_analysis,console.log("[SmartImporter] BUG-027: Extracted debug_analysis from NEXO error")),c(e=>({...e,isAnalyzing:!1,error:t})),b({message:t,debug_analysis:e}),v({stage:"error",percent:0,message:t}),r}finally{_(!1)}},[]),W=(0,t.useCallback)((e,t)=>{c(r=>({...r,answers:{...r.answers,[e]:t}}))},[]),z=(0,t.useCallback)(async()=>{if(!u.sessionState)throw Error("Nenhuma sessão NEXO ativa");c(e=>({...e,isAnalyzing:!0}));try{let e={...u.sessionState,answers:{...u.sessionState.answers,...u.answers},updated_at:new Date().toISOString()},t=await (0,n.nexoSubmitAnswers)({session_state:e,answers:u.answers});if(!t.data?.success)throw Error("Falha ao processar respostas");let r=t.data.session||e;c(e=>({...e,isAnalyzing:!1,sessionState:r,questions:t.data.remaining_questions||[]}))}catch(t){let e=t instanceof Error?t.message:"Erro ao processar respostas";throw c(t=>({...t,isAnalyzing:!1,error:e})),t}},[u.sessionState,u.answers]),X=(0,t.useMemo)(()=>u.questions.filter(e=>"critical"===e.importance).filter(e=>!u.answers[e.id]).length>0,[u.questions,u.answers]),D=(0,t.useMemo)(()=>null!==u.sessionId&&!u.isAnalyzing&&!X&&null===u.error,[u.sessionId,u.isAnalyzing,X,u.error]);return{detectedType:s,isProcessing:y,progress:f,error:h,preview:E,response:x,uploadAndProcess:O,clearPreview:U,confirmEntry:j,pendingEntries:d??[],pendingEntriesLoading:p,refreshPendingEntries:g,assignProject:Q,nexoState:u,useNexoFlow:i,setUseNexoFlow:l,uploadWithNexoAnalysis:K,answerNexoQuestion:W,submitNexoAnswers:z,hasNexoQuestions:X,isNexoReady:D}}function L(e){return({xml:"application/xml",pdf:"application/pdf",image:"image/jpeg",csv:"text/csv",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",unknown:"application/octet-stream"})[e]||"application/octet-stream"}e.s(["useSmartImporter",()=>O],96524);var U=e.i(71005);let j="agent-room";function Q({sessionId:e,enabled:s=!0,pollingInterval:o=5e3,enableWebSocket:i=!0}={}){let l=(0,a.useQueryClient)(),{isConnected:u,connectionState:c,reconnect:d}=function({enabled:e=!0,onEvent:r,onEvents:a,onConnectionChange:n,maxEvents:s=100,maxReconnectAttempts:o=10}={}){let i=(0,t.useRef)(null),l=(0,t.useRef)(0),u=(0,t.useRef)(null),c=(0,t.useRef)(null),d=(0,t.useRef)(!1),m=(0,t.useRef)(()=>{}),[p,g]=(0,t.useState)("closed"),[y,_]=(0,t.useState)([]),[f,v]=(0,t.useState)(0),h=(0,t.useCallback)(()=>{u.current&&(clearTimeout(u.current),u.current=null)},[]),w=(0,t.useCallback)(()=>{c.current&&(clearInterval(c.current),c.current=null)},[]),b=(0,t.useCallback)(e=>{g(e),n?.(e)},[n]),S=(0,t.useCallback)(e=>{try{let t=JSON.parse(e.data);switch(t.type){case"agent_events":t.events&&t.events.length>0&&(_(e=>[...t.events,...e].slice(0,s)),t.events.forEach(e=>r?.(e)),a?.(t.events));break;case"ping":case"ack":break;case"pong":console.debug("[AgentRoomWS] Heartbeat acknowledged");break;case"error":console.error("[AgentRoomWS] Server error:",t.error);break;default:console.warn("[AgentRoomWS] Unknown message type:",t)}}catch(e){console.error("[AgentRoomWS] Failed to parse message:",e)}},[s,r,a]),E=(0,t.useCallback)(()=>{if(!e||i.current?.readyState===WebSocket.OPEN||i.current?.readyState===WebSocket.CONNECTING)return;let t=U.agentCoreConfig.websocket.agentRoom;if(!t)return void console.warn("[AgentRoomWS] WebSocket URL not configured.");h(),d.current=!1,b("connecting");try{let r=new WebSocket(t);i.current=r,r.onopen=()=>{console.log("[AgentRoomWS] Connected"),b("open"),l.current=0,v(0),w(),c.current=setInterval(()=>{r.readyState===WebSocket.OPEN&&r.send(JSON.stringify({type:"ping"}))},3e4)},r.onmessage=S,r.onclose=t=>{if(console.log("[AgentRoomWS] Closed:",t.code,t.reason),w(),i.current=null,d.current)return void b("closed");if(e&&l.current<o){var r;let e,t,a=(r=l.current,e=1e3*Math.pow(2,r),t=.1*e*(2*Math.random()-1),Math.min(e+t,16e3));console.log(`[AgentRoomWS] Reconnecting in ${a}ms (attempt ${l.current+1})`),u.current=setTimeout(()=>{l.current+=1,v(l.current),m.current()},a),b("closed")}else l.current>=o?(console.error("[AgentRoomWS] Max reconnection attempts reached"),b("error")):b("closed")},r.onerror=e=>{console.error("[AgentRoomWS] Error:",e)}}catch(e){console.error("[AgentRoomWS] Failed to create WebSocket:",e),b("error")}},[e,h,w,b,S,o]);(0,t.useLayoutEffect)(()=>{m.current=E},[E]);let k=(0,t.useCallback)(()=>{d.current=!0,h(),w(),i.current&&(b("closing"),i.current.close(1e3,"Client disconnect"),i.current=null)},[h,w,b]),C=(0,t.useCallback)(()=>{l.current=0,v(0),k(),setTimeout(()=>{d.current=!1,E()},100)},[k,E]),q=(0,t.useCallback)(()=>{_([])},[]);return(0,t.useEffect)(()=>(e&&(0,t.startTransition)(()=>{E()}),()=>{d.current=!0,h(),w(),i.current&&(i.current.close(1e3,"Component unmount"),i.current=null)}),[e,E,h,w]),{isConnected:"open"===p,connectionState:p,events:y,reconnectAttempts:f,reconnect:C,disconnect:k,clearEvents:q}}({enabled:s&&i,onEvents:(0,t.useCallback)(t=>{l.setQueryData([j,e],e=>{if(!e)return e;let r=new Set(e.liveFeed.map(e=>e.id)),a=t.filter(e=>!r.has(e.id));return{...e,liveFeed:[...a,...e.liveFeed].slice(0,100),timestamp:new Date().toISOString()}})},[l,e])}),m=s&&!u,{data:p,isLoading:g,isError:y,error:_,isFetching:f,refetch:v,dataUpdatedAt:h}=(0,r.useQuery)({queryKey:[j,e],queryFn:async({signal:t})=>(await (0,n.getAgentRoomData)(e?{session_id:e}:void 0,{signal:t})).data,enabled:s,staleTime:2e3,refetchInterval:!!m&&o,refetchOnWindowFocus:!1}),w=p??null,b=w?.agents??[],S=w?.liveFeed??[],E=w?.pendingDecisions??[],k=w?.learningStories??[],C=w?.activeWorkflow??null,q=w?.timestamp??null,A=b.filter(e=>"trabalhando"===e.status).length,x=E.length,M=E.some(e=>"high"===e.priority||"critical"===e.priority);return{data:w,agents:b,liveFeed:S,pendingDecisions:E,learningStories:k,activeWorkflow:C,lastUpdated:q,dataUpdatedAt:h,isLoading:g,isError:y,error:_,isFetching:f,isWebSocketConnected:u,webSocketState:c,isRealTime:u,activeAgentCount:A,pendingDecisionCount:x,hasUrgentDecisions:M,refetch:(0,t.useCallback)(()=>{l.invalidateQueries({queryKey:[j]}),v()},[l,v]),reconnectWebSocket:d}}e.s(["useAgentRoom",()=>Q],11426),e.s([],8419)}]);